using Newtonsoft.Json;
using System;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Net;
using System.Text;
using System.Web;

public class CPHInline
{
    public bool Execute()
    {
        // Discord API endpoint for creating scheduled events
        string url = "https://discord.com/api/guilds/<id-of-your-discord-server>/scheduled-events";
        
        // Input vars
        var streamTitle = args["targetChannelTitle"].ToString();
        var streamLocation = string.Concat("https://www.twitch.tv/", args["targetUserName"].ToString());
        var streamDescription = args["targetDescriptionEscaped"].ToString();
        
        // Build API POST JSON payload (use an "Add target info for broadcaster" sub-action prior to "Execute Code")
        var content = JsonConvert.SerializeObject(new
	    {
	        name = streamTitle,
	        scheduled_start_time = DateTimeOffset.UtcNow.AddSeconds(5),
	        scheduled_end_time = DateTimeOffset.UtcNow.AddDays(1),
	        entity_type = 3,
	        privacy_level = "2",
	        entity_metadata = new
	        {
		        location = streamLocation
		    },
	        description = streamDescription
	    });
        
        // Init and prep http POST call
        // You'll need your Discord bot's token with "Manage Events" permission
        using HttpClient httpClient = new();
        var requestContent = new StringContent(content, Encoding.UTF8, "application/json");
        httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bot", "<discord-bot-token>");

        // Attempt POST and read the response to extract the newly created event id.
        // We will save the event id as an SB global variable so we can cleanup when stream ends.
        var response = httpClient.PostAsync(url, requestContent).Result;
        if (response.Content != null && response.IsSuccessStatusCode)
        {
            var guildEvent = JsonConvert.DeserializeObject<GuildEvent>(response.Content.ReadAsStringAsync().Result);
            CPH.SetGlobalVar("discordEventId", guildEvent.id, true);
        };
        return true;
    }

    // All we car about in this event is the event id
    private class GuildEvent
    {
    	public int id {get; set;}
    }
}